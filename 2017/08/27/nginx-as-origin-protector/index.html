<!DOCTYPE html><html lang="zh-cmn-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Using Nginx as Caching Layer of Origin | 湾区搬砖先生</title><meta name="description" content="This post gives the guide of how to setup Nginx as the origin web protector for CDN edge nodes."><meta name="keywords" content="Nginx, CDN, Network, Azure, Cache, AWS, S3, Traffic, ExpressRoute, Architecture, Security"><meta name="subtitle"><meta name="author" content="湾区搬砖先生"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="google-site-verification" content="lyjTywxijjRkIrnIgRUVF1Db4ZYeyviPMJZVsJpoiRc"><meta name="baidu-site-verification" content="db7LDCSzuo"><meta name="og:site_name" content="湾区搬砖先生"><meta name="og:type" content="website"><meta name="og:title" content="Using Nginx as Caching Layer of Origin"><meta name="og:descricption" content="This post gives the guide of how to setup Nginx as the origin web protector for CDN edge nodes."><meta name="og:url"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Using Nginx as Caching Layer of Origin"><meta name="twitter:description" content="This post gives the guide of how to setup Nginx as the origin web protector for CDN edge nodes."><meta name="twitter:site" content="@Ox333333"><meta name="twitter:url"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://travel.itrack.fit/atom.xml" title="湾区搬砖先生"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">文章列表</a></li><li class="nav-list-item"><a href="https://zpjiang.me" target="_blank" class="nav-list-link">技术博客</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">关于我</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">订阅</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Using Nginx as Caching Layer of Origin</h1><div class="post-info">Aug 27, 2017</div><div class="post-content"><p>It’s a common practice to setup multiple reverse proxies to protect your website from exposing to public network directly, it adds more flexibilities in load balancing, deployments, caching, etc. This post presents the necessity of an extra caching layer with Nginx, as well as giving a general guide in how to setup a Nginx server in front of the origin website.</p>
<h2 id="Why-isn’t-CDN-sufficient"><a href="#Why-isn’t-CDN-sufficient" class="headerlink" title="Why isn’t CDN sufficient?"></a>Why isn’t CDN sufficient?</h2><p><img src="https://raw.githubusercontent.com/0x333333/hexo_img/master/cdn-ntt-com2.jpg" alt="img"></p>
<a id="more"></a>
<p>CDN (Content Delivery Network) works as a caching layer for origin website, it caches static content in its edge nodes so that users can get the resources way faster than accessing origin website directly. At the same time, it helps to reduce the traffic on origin and limit the public access by hiding behind CDN network. CDN works like a giant caching layer.</p>
<p>However, as pointed in the picture above, CDN needs to fetch static content at the first time. If the location of origin website is very far from the edge nodes, e.g. with origin in US AWS S3 and the edge nodes in China, it can be a disaster to fetch resources oversea (not to mention that oversea S3 is banned in mainland China). One possible solution is to setup oversea CDN edge nodes and setup <a href="https://azure.microsoft.com/en-us/services/expressroute/" target="_blank" rel="noopener">express route</a> between mainland edge nodes and oversea nodes, but this is really expensive. Secondly, assuming that there is a new file that is requested by users at the same time and it has not been cached in CDN yet, CDN edge nodes will redirect the request to the origin website, it’s still a large traffic, an abrupt traffic increase may hit the origin server badly.</p>
<h2 id="Nginx-Can-Help"><a href="#Nginx-Can-Help" class="headerlink" title="Nginx Can Help"></a>Nginx Can Help</h2><p>Nginx is extremely famous for reverse proxying, it comes with a large amount of plugins that help Nginx to conquer the server industry. Nginx cache is one of them. Nginx can be used as a powerful caching layer in front of the origin to reduce duplicated HTTP requests on origin.</p>
<p>Within Azure data centers, data transmit rate can hit hundreds of megabytes per second between two standard VMs (the more cores, the higher bandwidth). It won’t cost much to setup two proxies in two data centers, with one in US and the other in mainland China, the network latency can be ignore especially for large file downloads, like videos, mobile App, firmware, etc.</p>
<h2 id="How-to-Setup-Nginx"><a href="#How-to-Setup-Nginx" class="headerlink" title="How to Setup Nginx"></a>How to Setup Nginx</h2><p>These steps were performed in CentOS 7.3, Azure A2 of 2 cores 3.5 GiB memory. The steps on other system may vary, please refer its <a href="https://www.nginx.com/resources/admin-guide/installing-nginx-open-source/" target="_blank" rel="noopener">official documentation</a> for details.</p>
<h3 id="0-Install-and-Launch-Nginx"><a href="#0-Install-and-Launch-Nginx" class="headerlink" title="0. Install and Launch Nginx"></a>0. Install and Launch Nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[xxx@azurevm ~]$ sudo yum install -y nginx</span><br><span class="line">[sudo] password <span class="keyword">for</span> xxx:</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * epel: mirror.vinahost.vn</span><br><span class="line">Resolving Dependencies</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure>
<p>Now Nginx is well installed, but not enabled for <code>systemctl</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check its status</span></span><br><span class="line">[xxx@azurevm ~]$ systemctl status nginx</span><br><span class="line">● nginx.service - The nginx HTTP and reverse proxy server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable Nginx as auto launch and maintained by systemd</span></span><br><span class="line">[xxx@azurevm ~]$ sudo systemctl <span class="built_in">enable</span> nginx</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.</span><br><span class="line">[xxx@azurevm ~]$</span><br><span class="line"></span><br><span class="line"><span class="comment"># Launch Nginx and check its status</span></span><br><span class="line">[xxx@azurevm ~]$ sudo systemctl start nginx</span><br><span class="line">[xxx@azurevm ~]$ sudo systemctl status nginx</span><br><span class="line">● nginx.service - The nginx HTTP and reverse proxy server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sun 2017-08-27 10:56:39 UTC; 6s ago</span><br><span class="line">  Process: 1829 ExecStart=/usr/sbin/nginx (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 1826 ExecStartPre=/usr/sbin/nginx -t (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 1824 ExecStartPre=/usr/bin/rm -f /run/nginx.pid (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 1831 (nginx)</span><br><span class="line">   CGroup: /system.slice/nginx.service</span><br><span class="line">           ├─1831 nginx: master process /usr/sbin/nginx</span><br><span class="line">           ├─1832 nginx: worker process</span><br><span class="line">           └─1833 nginx: worker process</span><br><span class="line"></span><br><span class="line">Aug 27 10:56:39 n0 systemd[1]: Starting The nginx HTTP and reverse proxy server...</span><br><span class="line">Aug 27 10:56:39 n0 nginx[1826]: nginx: the configuration file /etc/nginx/nginx.conf... ok</span><br><span class="line">Aug 27 10:56:39 n0 nginx[1826]: nginx: configuration file /etc/nginx/nginx.conf tes...ful</span><br><span class="line">Aug 27 10:56:39 n0 systemd[1]: Started The nginx HTTP and reverse proxy server.</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show <span class="keyword">in</span> full.</span><br></pre></td></tr></table></figure>
<h3 id="1-Setup-Nginx"><a href="#1-Setup-Nginx" class="headerlink" title="1. Setup Nginx"></a>1. Setup Nginx</h3><p>As indicated above, the configuration file can be found in <code>/etc/nginx/nginx.conf</code>.</p>
<p><img src="https://raw.githubusercontent.com/0x333333/hexo_img/master/Screen%20Shot%202017-08-27%20at%204.08.54%20AM.png" alt="img"></p>
<p>The first section defines the running user, worker process, log location and process id file location. Pay attention to <code>worker_process</code> and <code>worker_connections</code>, you may need to tune them according to your traffic volume. According to some tuning guide from DigitalOcean: <a href="https://www.digitalocean.com/community/tutorials/how-to-optimize-nginx-configuration" target="_blank" rel="noopener">How To Optimize Nginx Configuration</a></p>
<blockquote>
<p>It is common practice to run 1 worker process per core. Anything above this won’t hurt your system, but it will leave idle processes usually just lying about.</p>
</blockquote>
<p>The <code>worker_connections</code> directive tells our worker processes how many people can simultaneously be served by Nginx. Please make sure to setup a proper number of allowed file descriptor in CentOS, guides can be found here: <a href="https://serverfault.com/questions/637212/increasing-ulimit-on-centos" target="_blank" rel="noopener">Increasing ulimit on CentOS</a>.</p>
<p>Followed by that is <code>http</code> directive.</p>
<p><img src="https://raw.githubusercontent.com/0x333333/hexo_img/master/Screen%20Shot%202017-08-27%20at%204.19.16%20AM.png" alt="img"></p>
<p>It specifies the log format, location of access log and some other configurations. Pay attention to <code>keepalive_timeout</code>, for a high traffic service it would be better to setup up a lower timeout value so as to release waiting connections to new requests.</p>
<p><code>server</code> directive is the section where the origin website and cache rule are allocated.</p>
<p><img src="https://raw.githubusercontent.com/0x333333/hexo_img/master/Screen%20Shot%202017-08-27%20at%204.30.45%20AM.png" alt="img"></p>
<p>In this example, Nginx listens on port 80 and serves the html file located in <code>/usr/share/nginx/html</code> to all network traffic. For <code>40X</code> and <code>50X</code> requests it redirects the traffic to different notification pages.</p>
<p>Here is another example of setting up a reverse proxy.</p>
<p><img src="https://raw.githubusercontent.com/0x333333/hexo_img/master/1503833912364.jpg" alt="img"></p>
<p><code>upstream</code> is for origin website. <code>proxy_cache_path</code> is for cache location and cache validate time. <code>server_name</code> is your custom domain, current <code>location</code> is <code>/</code>, you can change it to other value according to this documentation: <a href="https://www.nginx.com/blog/nginx-caching-guide/" target="_blank" rel="noopener">A Guide to Caching with NGINX and NGINX Plus</a>.</p>
<p>For example, if you do not want to cache <code>php</code>, <code>asp</code> and some other files, you can use this location.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^/.+\.(php|aspx|asp|jsp|<span class="keyword">do</span>|dwr|cgi|fcgi|action|ashx|axd|json) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Within the <code>location</code> directive, you need to setup cache rule, caching time, caching status code, etc. Pay attention to <code>proxy_set_header</code>, if you are using CDN, you should use the same <code>Host</code> header as your custom domain, otherwise your origin website won’t recognize your Nginx reverse engine. Other details about his configuration can be found here: <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header" target="_blank" rel="noopener">Module ngx_http_proxy_module</a></p>
<p>Once configuration is updated, don’t forget to reload Nginx to enable it.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl reload nginx</span><br></pre></td></tr></table></figure>
<p>It’s highly suggested to use <code>reload</code> instead of <code>restart</code>, since Nginx will perform a graceful restart by launching new threads and waiting util current connections are all completed, then retire the old threads.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Nginx is far more than just a web server, it gives you a performant web service with little resource consumed. In this post, Nginx is used as a caching layer for origin website in a CDN service architecture, it helps to hide origin website from abrupt web traffic and accelerates the access performance by combining multiple reverse proxies. The example listed in this post only covers some main functionalities of Ningx proxy plugin, for more details please check its official documentation. Leave me a message if you have any question about the guide.</p>
</div></article></div></section><footer><div class="paginator"><a href="/2018/01/03/Christmas-Road-Trip/" class="prev">PREV</a><a href="/2017/08/22/Moved-to-bay-area/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'travel-itrack-fit';
var disqus_identifier = '2017/08/27/nginx-as-origin-protector/';
var disqus_title = 'Using Nginx as Caching Layer of Origin';
var disqus_url = 'http://travel.itrack.fit/2017/08/27/nginx-as-origin-protector/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//travel-itrack-fit.disqus.com/count.js" async></script><div class="copyright"><p>2013 - 2020 | <a href="http://travel.itrack.fit">湾区搬砖先生</a></p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-159358529-1",'auto');ga('send','pageview');</script></body></html>